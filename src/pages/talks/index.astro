---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";
import "../../styles/wall.css";
import "../../styles/talks.css";

const pageTitle = "Talks â€” Alex Gavrilescu";
const description = "A visual wall of recent talks, starting with the Vienna AI Engineering series.";

const talksEntries = await getCollection("talks");

// Interpret YYYY-MM-DD strings in local time so we don't surface talks a day early.
const toLocalDate = (isoDate) => {
  const [year, month, day] = isoDate.split("-").map(Number);
  return new Date(year, month - 1, day);
};

const formatDateLabel = (isoDate) =>
  new Intl.DateTimeFormat("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
  }).format(toLocalDate(isoDate));

const today = new Date();
const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
const tomorrowLocal = new Date(todayLocal);
tomorrowLocal.setDate(todayLocal.getDate() + 1);

const isDev = import.meta.env.DEV;

const talks = await Promise.all(
  talksEntries.map(async (entry) => {
    const { Content } = await render(entry);
    return {
      ...entry.data,
      Content,
      dateLabel: formatDateLabel(entry.data.dateISO),
    };
  }),
);

const filteredTalks = talks
  .sort((a, b) => toLocalDate(b.dateISO).getTime() - toLocalDate(a.dateISO).getTime())
  // Hide future talks only in builds so local dev shows full list.
  .filter((talk) =>
    isDev ? true : toLocalDate(talk.dateISO).getTime() <= tomorrowLocal.getTime(),
  );
---

<BaseLayout title={pageTitle} description={description}>
  <div class="bg-grain">
    <main class="wrap">
      <header class="wall-header">
        <h1><span>Talk</span> Wall</h1>
      </header>
      <section aria-label="Talks" class="wall">
        {filteredTalks.map((talk) => {
          const trimmedUrl = talk.url ? talk.url.trim() : "";
          const hasSlides = trimmedUrl.length > 0;
          const slidesStatus = talk.slidesStatus ?? (hasSlides ? "ready" : "soon");
          const showSlides = slidesStatus !== "none";
          const slidesLabel = slidesStatus === "ready" ? "Slides ready" : "Slides coming soon";
          const trimmedVideoUrl = talk.videoUrl ? talk.videoUrl.trim() : "";
          const hasVideo = trimmedVideoUrl.length > 0;
          const Focus = talk.Content;
          const logo = talk.logo ?? {
            src: "/talks/vienna-ai-engineering-logo.jpeg",
            alt: "Vienna AI Engineering logo",
            width: 140,
          };
          return (
            <article class="card">
              <div class="logo">
                <img
                  src={logo.src}
                  alt={logo.alt}
                  width={logo.width ?? 140}
                  height="118"
                  loading="lazy"
                  style={`width: ${logo.width ?? 140}px;`}
                />
                <span class="logo-detail">
                  <span class="logo-date">{talk.dateLabel}</span>
                </span>
              </div>
              <div>
                <h2>{talk.title}</h2>
                <p>{talk.tagline}</p>
              </div>
              <div class="focus">
                <Focus />
              </div>
              <div class="meta">
                <span class="pill pill-event">{talk.event}</span>
                {showSlides ? <span class="pill pill-status">{slidesLabel}</span> : null}
              </div>
              <div class="cta-group">
                {showSlides ? (
                  hasSlides ? (
                    <a class="cta cta-link" href={trimmedUrl} target="_blank" rel="noopener noreferrer">
                      <strong>View slides</strong>
                    </a>
                  ) : (
                    <span class="cta cta-status">Slides not available yet.</span>
                  )
                ) : null}
                {hasVideo ? (
                  <a
                    class="cta cta-link cta-link-video"
                    href={trimmedVideoUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <strong>Watch video</strong>
                  </a>
                ) : null}
              </div>
            </article>
          );
        })}
      </section>
    </main>
  </div>
</BaseLayout>
